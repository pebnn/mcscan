<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minecraft Server Scanner</title>
  <!-- Responsive meta tag -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
  <!-- Favicon - dynamically include if any server-icon file exists -->
  {% if favicon_exists %}
  <link rel="icon" type="{{ favicon_mime_type }}" href="{{ url_for('static', filename='server_icons/' + favicon_filename) }}">
  {% endif %}
  <style>
    /* DARK MODE & HIGH CONTRAST */
    body.dark-mode {
      background-color: #121212;
      color: #ffffff;
    }
    /* Ensure all text is white */
    * { color: #ffffff; }
    .container-fluid, .table, .thead-dark th, .table td {
      color: #ffffff !important;
    }
    .thead-dark th { background-color: #1e1e1e; }
    .table-bordered, .table td, .table th { border: 1px solid #333; }
    /* SERVER ICON */
    .server-icon {
      max-width: 64px;
      max-height: 64px;
      object-fit: cover;
      display: block;
      margin: 0 auto;
    }
    /* STICKY TOP BAR */
    .sticky-top-bar {
      background-color: #1e1e1e;
      padding: 10px 0;
      border-bottom: 1px solid #444;
      color: #ffffff;
    }
    /* INFO CARDS */
    .info-card {
      background-color: #343a40;
      color: #ffffff;
      border-radius: 15px;
      padding: 10px 20px;
      margin-right: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: inline-block;
      font-size: 1rem;
      white-space: nowrap;
    }
    .info-card .info-label { font-weight: bold; margin-right: 5px; }
    
    /* Responsive info cards - stack better on smaller screens */
    @media (max-width: 768px) {
      .info-card {
        font-size: 0.9rem;
        padding: 8px 16px;
        margin-right: 8px;
        margin-bottom: 8px;
      }
    }
    /* TABLE CONTAINER */
    #table-container { flex: 1 1 auto; overflow-y: auto; }
    /* PAGINATION */
    .pagination { margin: 20px 0; }
    
    /* Top pagination styling */
    #pagination-nav-top { 
      margin-bottom: 0; 
    }
    
    /* Compact pagination when inline with stats */
    #pagination-nav-top .pagination .page-link {
      padding: 6px 12px;
      font-size: 0.9rem;
    }
    
    /* Responsive pagination */
    @media (max-width: 768px) {
      #pagination-nav-top .pagination .page-link {
        padding: 4px 8px;
        font-size: 0.85rem;
      }
    }
    
    /* Sticky Header Styles */
    .sticky-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d30 100%);
      border-bottom: 2px solid #007bff;
      z-index: 1000;
      padding: 8px 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      transform: translateY(-100%);
      transition: transform 0.3s ease-in-out;
    }
    
    .sticky-header.visible {
      transform: translateY(0);
    }
    
    .sticky-header .btn {
      padding: 4px 8px;
      font-size: 0.85rem;
      margin: 0 2px;
    }
    
    .sticky-header .form-control {
      height: 32px;
      font-size: 0.85rem;
      padding: 4px 8px;
    }
    
    .sticky-header .input-group-append .btn {
      height: 32px;
      padding: 4px 12px;
    }
    
    .sticky-header .pagination {
      margin: 0;
      font-size: 0.85rem;
    }
    
    .sticky-header .pagination .page-link {
      padding: 4px 8px;
      margin: 0 1px;
    }
    
    .sticky-header .per-page-select {
      height: 32px;
      font-size: 0.85rem;
      padding: 4px 8px;
      width: 70px !important;
    }
    
    .sticky-header h6 {
      margin: 0;
      font-size: 1rem;
      font-weight: bold;
      color: #ffffff;
    }
    
    /* Horizontal progress bar in sticky header */
    #sticky-progress-container {
      transition: all 0.3s ease-in-out;
      min-width: 200px;
      max-width: 300px;
    }
    
    #sticky-progress-container .progress {
      background-color: rgba(255,255,255,0.2);
      border-radius: 3px;
      min-width: 150px;
    }
    
    #sticky-progress-container .progress-bar {
      background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #007bff 100%);
      transition: width 0.3s ease;
    }
    
    #sticky-progress-text {
      min-width: 40px;
      text-align: right;
    }
    
    /* Add top margin to content when sticky header is active */
    body.sticky-active {
      margin-top: 80px;
    }
    
    /* Hide sticky header on mobile devices to save space */
    @media (max-width: 768px) {
      .sticky-header {
        display: none !important;
      }
      body.sticky-active {
        margin-top: 0;
      }
    }
    
    /* Hide progress bar on medium screens to save space */
    @media (max-width: 992px) {
      #sticky-progress-container {
        display: none !important;
      }
    }
    /* JUMP-TO-PAGE INPUT */
    .jump-page-container { max-width: 200px; margin: 20px auto; }
    /* NOTIFICATION CONTAINER */
    #notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .notification {
      background-color: #333;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      opacity: 0.95;
    }
    /* SORT HEADER STYLES */
    .sort-header { cursor: pointer; }
    .sort-arrows { font-size: 0.8em; margin-left: 5px; }
    /* TRASH ICON */
    .trash-icon { font-size: 1.2em; color: #ffffff; }
    /* FAVORITE BUTTON STYLES */
    .favorite-btn {
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid #ffffff;
      border-radius: 4px;
      padding: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .favorite-btn:hover { background-color: rgba(255, 255, 255, 0.3); }
    /* Set outlined star to white and filled star to yellow */
    .favorite-btn i.far { color: #ffffff; }
    .favorite-btn i.fas { color: yellow; }
    /* ACTIONS CONTAINER: Force horizontal layout */
    .actions-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-evenly;
      gap: 10px;
      white-space: nowrap;
    }
    /* Set a minimum width for the Actions column */
    td.actions-column, th.actions-column {
      min-width: 150px;
      vertical-align: middle;
    }
    /* HEADER ICON COLUMN */
    .header-icon { text-align: center; }
    /* LOADING SPINNER */
    #loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 9999;
    }
    /* PROGRESS BAR FOR REFRESH ALL */
    #refresh-progress-container { display: none; margin-bottom: 20px; }
    /* REFRESH CONFIG MODAL */
    .modal-content {
      background-color: #2c2c2c;
      color: #ffffff;
    }
    .modal-header, .modal-body, .modal-footer {
      background-color: #2c2c2c;
      color: #ffffff;
    }
    .modal-header .close span { color: #ffffff; }
    .list-group-item { background-color: #343a40; border-color: #444444; }
    /* Ensure long MOTD text wraps within its cell */
    td:nth-child(4) {
      max-width: 400px;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* Minecraft MOTD styling */
    .motd-text {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
    }
    /* TRANSITIONS */
    body, .table { transition: background-color 0.3s, color 0.3s; }
    /* MODAL OVERRIDES (PLAYER LIST, DELETE) */
    .modal-content, .modal-header, .modal-body, .modal-footer {
      background-color: #2c2c2c;
      color: #ffffff;
    }
    /* Refresh button icon styling */
    .btn-primary .fa-sync-alt { color: #ffffff; }
  </style>
</head>
<body class="dark-mode">
  <!-- Hidden element to store pagination data -->
  <div id="server-data"
       data-current-page="{{ pagination.page }}"
       data-per-page="{{ request.args.get('per_page', 50)|int }}"
       data-total="{{ pagination.total }}">
  </div>

  <!-- Sticky Header -->
  <div id="sticky-header" class="sticky-header">
    <div class="container-fluid">
      <div class="row align-items-center">
        <!-- Left: Title, Controls, and Progress Bar -->
        <div class="col-md-5">
          <div class="d-flex align-items-center">
            <h6 class="mr-3">MC Scanner</h6>
            <button id="sticky-refresh-all-btn" class="btn btn-primary" title="Refresh all servers on current page">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button id="sticky-check-page-wl-btn" class="btn btn-info" title="Check whitelist for entire page">
              <i class="fas fa-user-check"></i>
              <span class="ml-1 d-none d-md-inline">Check Whitelist</span>
            </button>
            <button id="sticky-refresh-config-btn" class="btn btn-secondary">
              <i class="fas fa-cog"></i>
            </button>
            <button id="sticky-toggle-favorites-btn" class="btn btn-secondary">
              <i class="far fa-star"></i>
            </button>
            
            <!-- Horizontal Progress Bar (hidden by default) -->
            <div id="sticky-progress-container" class="ml-3 flex-grow-1" style="display: none;">
              <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 mr-2" style="height: 6px;">
                  <div id="sticky-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                       role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                <small id="sticky-progress-text" class="text-white text-nowrap" style="font-size: 0.75rem;">0%</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Center: Search -->
        <div class="col-md-4">
          <div class="input-group" id="sticky-search-container">
            <input type="text" id="sticky-search" class="form-control" placeholder="Search...">
            <div class="input-group-append">
              <button id="sticky-search-btn" class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Right: Pagination and Per Page -->
        <div class="col-md-3">
          <div class="d-flex align-items-center justify-content-end">
            <select id="sticky-per-page-select" class="form-control per-page-select mr-2">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="250">250</option>
              <option value="300">300</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
            </select>
            <nav id="sticky-pagination" class="d-none d-lg-block">
              <!-- Pagination will be dynamically updated -->
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notification-container"></div>

  <div class="container-fluid mt-4 d-flex flex-column">
    <!-- Top Bar with Refresh All, Cogwheel, and Global Favorites Toggle -->
    <div class="sticky-top-bar mb-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1>Minecraft Server Scanner</h1>
        </div>
        <div class="col-md-6 text-md-right">
          <button id="refresh-all-btn" class="btn btn-primary" title="Refresh all servers on current page">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button id="check-page-wl-btn" class="btn btn-info ml-2" title="Check whitelist for entire page">
            <i class="fas fa-user-check"></i>
            <span class="ml-1">Check Whitelist</span>
          </button>
          <button id="refresh-config-btn" class="btn btn-secondary ml-2">
            <i class="fas fa-cog"></i>
          </button>
          <button id="toggle-favorites-btn" class="btn btn-secondary ml-2">
            <i class="far fa-star"></i> Favorites
          </button>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="input-group">
            <input type="text" id="search" class="form-control" placeholder="Search servers..." value="{{ search_query }}">
            <div class="input-group-append">
              <button id="search-btn" class="btn btn-outline-secondary" type="button">Search</button>
            </div>
          </div>
        </div>
        <div class="col-md-6 text-md-right">
          <!-- Per-page Dropdown -->
          <select id="per-page-select" class="form-control w-auto d-inline-block">
            <option value="25" {% if request.args.get('per_page', 50)|int == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if request.args.get('per_page', 50)|int == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if request.args.get('per_page', 50)|int == 100 %}selected{% endif %}>100</option>
            <option value="250" {% if request.args.get('per_page', 50)|int == 250 %}selected{% endif %}>250</option>
            <option value="300" {% if request.args.get('per_page', 50)|int == 300 %}selected{% endif %}>300</option>
            <option value="500" {% if request.args.get('per_page', 50)|int == 500 %}selected{% endif %}>500</option>
            <option value="1000" {% if request.args.get('per_page', 50)|int == 1000 %}selected{% endif %}>1000</option>
          </select>
          <span class="ml-2">per page</span>
        </div>
      </div>
    </div>

    <!-- Stats and Pagination Row -->
    <div class="row mb-4 align-items-center">
      <!-- Left: Database Stats -->
      <div class="col-md-6">
        <div class="d-flex align-items-center flex-wrap">
          <div class="info-card mr-3 mb-2">
            <span class="info-label">Total Entries:</span>
            <span id="total-entries">{{ total_entries }}</span>
          </div>
          <div class="info-card mr-3 mb-2">
            <span class="info-label">Filtered Entries:</span>
            <span id="filtered-entries">{{ filtered_entries }}</span>
          </div>
          <div class="info-card mb-2">
            <span class="info-label">Last Updated:</span>
            <span id="last-updated">{{ last_updated }}</span>
          </div>
        </div>
      </div>
      
      <!-- Right: Pagination -->
      <div class="col-md-6 mt-3 mt-md-0">
        <nav aria-label="Server Pagination" id="pagination-nav-top">
          <ul class="pagination justify-content-md-end justify-content-center mb-0">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=pagination.prev_num, search=search_query, sort_by=sort_by, sort_order=sort_order, per_page=request.args.get('per_page', 50)) }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}

        {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
          {% if page_num %}
            {% if page_num == pagination.page %}
            <li class="page-item active" aria-current="page">
              <span class="page-link">{{ page_num }}</span>
            </li>
            {% else %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('index', page=page_num, search=search_query, sort_by=sort_by, sort_order=sort_order, per_page=request.args.get('per_page', 50)) }}">{{ page_num }}</a>
            </li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=pagination.next_num, search=search_query, sort_by=sort_by, sort_order=sort_order, per_page=request.args.get('per_page', 50)) }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
          </ul>
        </nav>
      </div>
    </div>

    <!-- Progress Bar for Refresh All -->
    <div id="refresh-progress-container" class="mb-4">
      <h4 id="refresh-progress-text">Refreshing 0 servers...</h4>
      <div class="progress">
        <div id="refresh-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
             role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">
          0%
        </div>
      </div>
    </div>

    <!-- Table Container -->
    <div id="table-container">
      <table class="table table-bordered table-hover">
        <thead class="thead-dark">
          <tr>
            <th class="header-icon">Icon</th>
            <th class="sort-header" data-sort-by="ip">
              IP:Port <i class="fas fa-sort sort-arrows"></i>
            </th>
            <th>Whitelist</th>
            <th class="sort-header" data-sort-by="motd">
              MOTD <i class="fas fa-sort sort-arrows"></i>
            </th>
            <th class="sort-header" data-sort-by="version">
              Version <i class="fas fa-sort sort-arrows"></i>
            </th>
            <th class="sort-header" data-sort-by="players">
              Players <i class="fas fa-sort sort-arrows"></i>
            </th>
            <th class="sort-header" data-sort-by="country">
              Country <i class="fas fa-sort sort-arrows"></i>
            </th>
            <th class="sort-header" data-sort-by="date_added">
              Date Added <i class="fas fa-sort sort-arrows"></i>
            </th>
            <th class="actions-column">Actions</th>
            <th class="sort-header" data-sort-by="reachable">
              Reachable <i class="fas fa-sort sort-arrows"></i>
            </th>
          </tr>
        </thead>
        <tbody id="server-list">
          {% for server in pagination.items %}
          <tr data-server-id="{{ server.id }}">
            <td class="header-icon">
              <img src="{{ url_for('static', filename=server.server_icon) }}" alt="Server Icon" class="server-icon" loading="lazy">
            </td>
            <td>
              <div class="ip-container">
                <div class="ip-text">{{ server.ip }}:{{ server.port }}</div>
                <button class="btn btn-sm btn-secondary copy-btn" data-ip="{{ server.ip }}" data-port="{{ server.port }}">
                  Copy IP
                </button>
              </div>
            </td>
            <td>
              <div class="whitelist-container">
                <button class="btn btn-sm btn-info wl-check-btn" data-id="{{ server.id }}">Check</button>
                <span class="wl-status ml-2" style="font-size: 0.9rem;"></span>
              </div>
            </td>
            <td class="motd-text">{{ server.motd | motd_format | safe }}</td>
            <td>{{ server.version }}</td>
            <td>
              <div class="players-container">
                <div class="players-number">{{ server.players }}</div>
                <button class="btn btn-sm btn-info view-players-btn" data-id="{{ server.id }}" data-ip="{{ server.ip }}" data-port="{{ server.port }}">
                  View Players
                </button>
              </div>
            </td>
            <td>{{ server.country }}</td>
            <td>{{ server.date_added.strftime('%Y-%m-%d %H:%M') if server.date_added else 'Unknown' }}</td>
            <td class="actions-column">
              <div class="actions-container">
                <button class="btn btn-sm btn-primary refresh-btn" data-id="{{ server.id }}">
                  <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-sm favorite-btn" data-id="{{ server.id }}">
                  <i class="far fa-star"></i>
                </button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="{{ server.id }}">
                  <i class="fas fa-trash-alt trash-icon"></i>
                </button>
              </div>
            </td>
            <td>
              {% if server.reachable %}
                <span class="text-success">&#x1F7E2;</span>
              {% else %}
                <span class="text-danger">&#x1F534;</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination Widget (hidden in favorites view) -->
    <nav aria-label="Server Pagination" id="pagination-nav">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=pagination.prev_num, search=search_query, sort_by=sort_by, sort_order=sort_order, per_page=request.args.get('per_page', 50)) }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}

        {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
          {% if page_num %}
            {% if page_num == pagination.page %}
            <li class="page-item active" aria-current="page">
              <span class="page-link">{{ page_num }}</span>
            </li>
            {% else %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('index', page=page_num, search=search_query, sort_by=sort_by, sort_order=sort_order, per_page=request.args.get('per_page', 50)) }}">{{ page_num }}</a>
            </li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', page=pagination.next_num, search=search_query, sort_by=sort_by, sort_order=sort_order, per_page=request.args.get('per_page', 50)) }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </nav>

    <!-- Jump-to-Page Input -->
    <div class="input-group jump-page-container">
      <input type="number" id="jump-page" class="form-control" placeholder="Page #" min="1">
      <div class="input-group-append">
        <button id="jump-page-btn" class="btn btn-secondary" type="button">Go</button>
      </div>
    </div>
  </div>

  <!-- General Settings Modal (Cogwheel Modal) -->
  <div class="modal fade" id="generalSettingsModal" tabindex="-1" aria-labelledby="generalSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="generalSettingsModalLabel">Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" style="color:#ffffff;">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="refresh-count-input">Refresh: number of servers to refresh</label>
          <input type="number" id="refresh-count-input" class="form-control" placeholder="e.g., 5000" min="1">
            <small class="form-text text-muted">Refresh All will process up to this many servers.</small>
          </div>
          <hr/>
          <div class="form-group">
            <label>Authentication Method</label>
            <div class="nav nav-tabs" id="auth-tabs" role="tablist">
              <a class="nav-item nav-link active" id="token-tab" data-toggle="tab" href="#token-panel" role="tab">Minecraft Token</a>
          </div>
            <div class="tab-content mt-3" id="auth-tab-content">
              <div class="tab-pane fade show active" id="token-panel" role="tabpanel">
          <div class="form-group">
                  <label for="access-token-input">Minecraft Access Token</label>
                  <input type="password" id="access-token-input" class="form-control" placeholder="Paste Minecraft access token">
                  <small class="form-text text-muted">
                    Use the 3-part Java access token (starts with <code>eyJ</code>). Do not paste Xbox 5-part tokens.
                  </small>
          </div>
            </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="save-settings-btn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts Container -->
  <div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; min-height: 200px;">
    <div id="toast-container">
      <!-- Toast messages will be appended here -->
    </div>
  </div>

  <!-- Player List Modal (Dark Mode) -->
  <div class="modal fade" id="playerListModal" tabindex="-1" aria-labelledby="playerListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Players on <span id="modal-server-ip"></span>: <span id="modal-server-port"></span>
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" style="color:#ffffff;">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <ul id="player-list" class="list-group">
            <!-- Player names will be dynamically populated -->
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal (Dark Mode) -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" style="color:#ffffff;">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Are you sure you want to permanently delete this server from the list?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" id="confirm-delete-btn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <script>
    // Global variable for refresh count (default)
    let refreshCount = 5000;
    // Global flag for showing favorites only
    let showFavoritesOnly = false;
    // Use localStorage to persist favorites; key: "favorites"
    function getFavorites() {
      let favs = localStorage.getItem("favorites");
      return favs ? JSON.parse(favs) : [];
    }
    function setFavorites(favs) {
      localStorage.setItem("favorites", JSON.stringify(favs));
    }
    
    // Use localStorage to persist whitelist status; key: "whitelistStatus"
    function getWhitelistStatus() {
      let status = localStorage.getItem("whitelistStatus");
      return status ? JSON.parse(status) : {};
    }
    function setWhitelistStatus(serverId, statusData) {
      let status = getWhitelistStatus();
      status[serverId] = {
        ...statusData,
        timestamp: Date.now()
      };
      // Clean up old entries (older than 24 hours) to prevent excessive storage
      let cutoff = Date.now() - (24 * 60 * 60 * 1000);
      Object.keys(status).forEach(id => {
        if (status[id].timestamp < cutoff) {
          delete status[id];
        }
      });
      localStorage.setItem("whitelistStatus", JSON.stringify(status));
    }
    function getWhitelistStatusForServer(serverId) {
      let status = getWhitelistStatus();
      return status[serverId] || null;
    }
    
    // Restore whitelist status from localStorage for all visible servers
    function restoreWhitelistStatus() {
      $('tr[data-server-id]').each(function() {
        let row = $(this);
        let serverId = row.data('server-id');
        let statusData = getWhitelistStatusForServer(serverId);
        
        if (statusData) {
          let statusEl = row.find('.wl-status');
          let statusText = statusData.statusText || '';
          let statusColor = statusData.statusColor || '#6c757d';
          let tooltipText = statusData.tooltipText || statusText;
          
          statusEl.text(statusText).css('color', statusColor);
          if (tooltipText) {
            statusEl.attr('title', tooltipText);
          }
        }
      });
    }
    // Update favorite button appearance based on status
    function updateFavoriteButton(btn, isFav) {
      let icon = $(btn).find('i');
      if (isFav) {
        icon.removeClass('far').addClass('fas');
      } else {
        icon.removeClass('fas').addClass('far');
      }
    }
    // Load all favorite servers via AJAX (global favorites view)
    function loadFavoritesView() {
      let favs = getFavorites();
      if(favs.length === 0) {
        $("#server-list").empty().append("<tr><td colspan='9'>No favorites found.</td></tr>");
        $("#pagination-nav").hide();
        $("#pagination-nav-top").hide();
        $("#sticky-pagination").hide();
        return;
      }
      $.ajax({
        url: "/api/servers/favorites",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ favorites: favs }),
        success: function(response) {
          let servers = response.servers;
          let tbody = $("#server-list");
          tbody.empty();
          servers.forEach(function(s) {
            let row = `<tr data-server-id="${s.id}">
              <td class="header-icon">
                <img src="/static/${s.server_icon}" alt="Server Icon" class="server-icon" loading="lazy">
              </td>
              <td>
                <div class="ip-container">
                  <div class="ip-text">${s.ip}:${s.port}</div>
                  <button class="btn btn-sm btn-secondary copy-btn" data-ip="${s.ip}" data-port="${s.port}">Copy IP</button>
                </div>
              </td>
              <td>
                <div class="whitelist-container">
                  <button class="btn btn-sm btn-info wl-check-btn" data-id="${s.id}">Check</button>
                  <span class="wl-status ml-2" style="font-size: 0.9rem;"></span>
                </div>
              </td>
              <td class="motd-text">${formatMinecraftMOTD(s.motd)}</td>
              <td>${s.version}</td>
              <td>
                <div class="players-container">
                  <div class="players-number">${s.players}</div>
                  <button class="btn btn-sm btn-info view-players-btn" data-id="${s.id}" data-ip="${s.ip}" data-port="${s.port}">View Players</button>
                </div>
              </td>
              <td>${s.country}</td>
              <td>${s.date_added ? new Date(s.date_added).toLocaleString('sv-SE', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}).replace(' ', ' ') : 'Unknown'}</td>
              <td class="actions-column">
                <div class="actions-container">
                  <button class="btn btn-sm btn-primary refresh-btn" data-id="${s.id}">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                  <button class="btn btn-sm favorite-btn" data-id="${s.id}">
                    <i class="far fa-star"></i>
                  </button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${s.id}">
                    <i class="fas fa-trash-alt trash-icon"></i>
                  </button>
                </div>
              </td>
              <td>
                ${ s.reachable ? '<span class="text-success">&#x1F7E2;</span>' : '<span class="text-danger">&#x1F534;</span>' }
              </td>
            </tr>`;
            tbody.append(row);
          });
          // Set favorite icons based on localStorage.
          let currentFavs = getFavorites();
          tbody.find('tr').each(function(){
             let id = $(this).data('server-id');
             if(currentFavs.indexOf(id) !== -1) {
               $(this).find('.favorite-btn i').removeClass('far').addClass('fas');
             }
          });
          $("#pagination-nav").hide();  // Hide pagination in favorites view.
          $("#pagination-nav-top").hide();  // Hide top pagination in favorites view.
          $("#sticky-pagination").hide();  // Hide sticky pagination in favorites view.
          restoreWhitelistStatus(); // Restore whitelist status from localStorage
          bindRowEvents();
        },
        error: function(){
          showNotification("Failed to load favorites.");
        }
      });
    }
    // Global Favorites toggle button event
    $('#toggle-favorites-btn').on('click', function(){
      showFavoritesOnly = !showFavoritesOnly;
      if (showFavoritesOnly) {
        $(this).removeClass('btn-secondary').addClass('btn-warning');
        $(this).find('i').removeClass('far').addClass('fas');
        loadFavoritesView();
      } else {
        $(this).removeClass('btn-warning').addClass('btn-secondary');
        $(this).find('i').removeClass('fas').addClass('far');
        // Reload the default paginated view
        window.location.href = window.location.pathname + "?page=1";
      }
    });
    // On page load, update favorite buttons on current rows and bind row events
    $(document).ready(function(){
      let favs = getFavorites();
      $('.favorite-btn').each(function(){
        let id = $(this).data('id');
        updateFavoriteButton(this, favs.indexOf(id) !== -1);
      });
      restoreWhitelistStatus(); // Restore whitelist status from localStorage
      bindRowEvents();
    });
    // Refresh All function: if in favorites view, refresh only favorites.
    function refreshAllServers() {
      if (showFavoritesOnly) {
        let favs = getFavorites();
        if(favs.length === 0) {
          showNotification("No favorite servers to refresh.");
          return;
        }
        let totalToRefresh = favs.length;
        $('#refresh-progress-container').show();
        $('#refresh-progress-text').text("Refreshing " + totalToRefresh + " favorite servers...");
        $('#refresh-progress-bar').css('width', '0%').text('0%');
        let refreshProcessed = 0;
        let faviconProcessed = 0;
        let refreshPromises = [];
        
        // Function to safely update progress with two phases
        function updateRefreshProgress() {
          refreshProcessed = Math.min(refreshProcessed + 1, totalToRefresh);
          updateOverallProgress();
        }
        
        function updateFaviconProgress() {
          faviconProcessed = Math.min(faviconProcessed + 1, totalToRefresh);
          updateOverallProgress();
        }
        
        function updateOverallProgress() {
          // Phase 1: Server refresh (0-80%)
          let refreshPercent = Math.round((refreshProcessed / totalToRefresh) * 80);
          // Phase 2: Favicon loading (80-100%)
          let faviconPercent = Math.round((faviconProcessed / totalToRefresh) * 20);
          let totalPercent = Math.min(refreshPercent + faviconPercent, 100);
          
          if (totalPercent < 80) {
            $('#refresh-progress-bar').css('width', totalPercent + '%').text(totalPercent + '% - Checking servers...');
          } else if (totalPercent < 100) {
            $('#refresh-progress-bar').css('width', totalPercent + '%').text(totalPercent + '% - Loading icons...');
          } else {
            $('#refresh-progress-bar').css('width', totalPercent + '%').text('100% - Complete!');
            checkCompletion();
          }
        }
        
        // Function to check if all phases are complete for favorites
        function checkCompletion() {
          if (refreshProcessed >= totalToRefresh && faviconProcessed >= totalToRefresh) {
            clearTimeout(timeoutId);
            setTimeout(function() {
              $('#refresh-progress-container').hide();
              showNotification("Refresh All favorites completed.");
              loadFavoritesView();
            }, 500); // Small delay to show 100% complete
          }
        }
        
        favs.forEach(function(serverId) {
          let p = $.ajax({
            url: "/api/refresh/" + serverId,
            method: "POST"
          }).then(function(response) {
            updateRefreshProgress();
            
            // Track favicon loading for favorites view
            let s = response.server;
            if (response.status === 'failed') {
              updateFaviconProgress();
              return;
            }
            if (showFavoritesOnly) {
              // In favorites view, track favicon loading
              let existingImg = $(`.server-icon[data-server-id="${serverId}"]`);
              if (existingImg.length > 0) {
                let oldSrc = existingImg.attr('src');
                let newSrc = "/static/" + s.server_icon;
                
                if (oldSrc !== newSrc) {
                  existingImg.off('load error').on('load error', function() {
                    updateFaviconProgress();
                  }).attr('src', newSrc);
                } else {
                  updateFaviconProgress();
                }
              } else {
                updateFaviconProgress();
              }
            } else {
              // Not in favorites view, just count as complete
              updateFaviconProgress();
            }
          }).fail(function() {
            updateRefreshProgress();
            updateFaviconProgress();
          });
          refreshPromises.push(p);
        });
        // Add timeout safety (30 seconds max)
        let timeoutId = setTimeout(function() {
          $('#refresh-progress-container').hide();
          showNotification("Refresh All favorites completed (some requests may have timed out).");
          loadFavoritesView();
        }, 30000);
        
        $.when.apply($, refreshPromises).then(function(){
          // All AJAX requests completed, but favicons might still be loading
          setTimeout(checkCompletion, 1000); // Check after 1 second if favicons are done
        }).fail(function() {
          clearTimeout(timeoutId);
          $('#refresh-progress-container').hide();
          showNotification("Refresh All favorites completed with some errors.");
          loadFavoritesView();
        });
      } else {
        // If not in favorites view, refresh all servers in current view
        let currentServers = [];
        $('tr[data-server-id]').each(function() {
          let serverId = $(this).attr('data-server-id');
          if (serverId) {
            currentServers.push(parseInt(serverId));
          }
        });
        
        if (currentServers.length === 0) {
          showNotification("No servers to refresh.");
          return;
        }
        
        let totalToRefresh = currentServers.length;
        $('#refresh-progress-container').show();
        $('#refresh-progress-text').text("Refreshing " + totalToRefresh + " servers...");
        $('#refresh-progress-bar').css('width', '0%').text('0%');
        
        let refreshProcessed = 0;
        let faviconProcessed = 0;
        let refreshPromises = [];
        
        // Function to safely update progress with two phases
        function updateRefreshProgress() {
          refreshProcessed = Math.min(refreshProcessed + 1, totalToRefresh);
          updateOverallProgress();
        }
        
        function updateFaviconProgress() {
          faviconProcessed = Math.min(faviconProcessed + 1, totalToRefresh);
          updateOverallProgress();
        }
        
        function updateOverallProgress() {
          // Phase 1: Server refresh (0-80%)
          let refreshPercent = Math.round((refreshProcessed / totalToRefresh) * 80);
          // Phase 2: Favicon loading (80-100%)
          let faviconPercent = Math.round((faviconProcessed / totalToRefresh) * 20);
          let totalPercent = Math.min(refreshPercent + faviconPercent, 100);
          
          if (totalPercent < 80) {
            $('#refresh-progress-bar').css('width', totalPercent + '%').text(totalPercent + '% - Checking servers...');
          } else if (totalPercent < 100) {
            $('#refresh-progress-bar').css('width', totalPercent + '%').text(totalPercent + '% - Loading icons...');
          } else {
            $('#refresh-progress-bar').css('width', totalPercent + '%').text('100% - Complete!');
            // Check if we should hide the progress bar
            checkCompletion();
          }
        }
        
        currentServers.forEach(function(serverId) {
          let p = $.ajax({
            url: "/api/refresh/" + serverId,
            method: "POST"
          }).then(function(response) {
            updateRefreshProgress();
            
            // Update the row with new data or mark offline
            let row = $('tr[data-server-id="' + serverId + '"]');
            if (response.status === 'failed') {
              if (row.length > 0) {
                row.find('td').eq(9).html('<span class="text-danger">&#x1F534;</span>');
                row.find('td').eq(5).find('.players-number').text('0');
              }
              updateFaviconProgress();
              return;
            }
            let s = response.server;
            if (row.length > 0) {
              // Update favicon with loading tracking
              let imgElement = row.find('td.header-icon img.server-icon');
              let oldSrc = imgElement.attr('src');
              let newSrc = "/static/" + s.server_icon;
              
              if (oldSrc !== newSrc) {
                // Track favicon loading
                imgElement.off('load error').on('load error', function() {
                  updateFaviconProgress();
                }).attr('src', newSrc);
              } else {
                // Same icon, no loading needed
                updateFaviconProgress();
              }
              
              row.find('td').eq(3).addClass('motd-text').html(formatMinecraftMOTD(s.motd));
              row.find('td').eq(4).text(s.version);
              row.find('td').eq(5).html(`
                <div class="players-container">
                  <div class="players-number">${s.players}</div>
                  <button class="btn btn-sm btn-info view-players-btn" data-id="${s.id}" data-ip="${s.ip}" data-port="${s.port}">View Players</button>
                </div>
              `);
              row.find('td').eq(6).text(s.country);
              row.find('td').eq(7).text(s.date_added ? new Date(s.date_added).toLocaleString('sv-SE', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}).replace(' ', ' ') : 'Unknown');
              row.find('td').eq(9).html(s.reachable ? '<span class="text-success">&#x1F7E2;</span>' : '<span class="text-danger">&#x1F534;</span>');
            } else {
              // Row not found, still count as favicon processed
              updateFaviconProgress();
            }
          }).fail(function() {
            updateRefreshProgress();
            updateFaviconProgress(); // Count failed requests as complete
          });
          refreshPromises.push(p);
        });
        
        // Add timeout safety (30 seconds max)
        let timeoutId = setTimeout(function() {
          $('#refresh-progress-container').hide();
          showNotification("Refresh All completed for " + totalToRefresh + " servers (some requests may have timed out).");
          bindRowEvents();
        }, 30000);
        
        // Function to check if all phases are complete
        function checkCompletion() {
          if (refreshProcessed >= totalToRefresh && faviconProcessed >= totalToRefresh) {
            clearTimeout(timeoutId);
            setTimeout(function() {
              $('#refresh-progress-container').hide();
              showNotification("Refresh All completed for " + totalToRefresh + " servers.");
              bindRowEvents();
            }, 500); // Small delay to show 100% complete
          }
        }
        
        $.when.apply($, refreshPromises).then(function(){
          // All AJAX requests completed, but favicons might still be loading
          // The checkCompletion function will handle hiding the progress bar
          setTimeout(checkCompletion, 1000); // Check after 1 second if favicons are done
        }).fail(function() {
          clearTimeout(timeoutId);
          $('#refresh-progress-container').hide();
          showNotification("Refresh All completed for " + totalToRefresh + " servers with some errors.");
          bindRowEvents();
        });
      }
    }

    // Function to format Minecraft MOTD with color codes
    function formatMinecraftMOTD(motd) {
      if (!motd) return '';
      
      // Define color mapping (same as server-side)
      const colorMap = {
        '0': '#000000',  // Black
        '1': '#0000AA',  // Dark Blue
        '2': '#00AA00',  // Dark Green
        '3': '#00AAAA',  // Dark Aqua
        '4': '#AA0000',  // Dark Red
        '5': '#AA00AA',  // Dark Purple
        '6': '#FFAA00',  // Gold
        '7': '#AAAAAA',  // Gray
        '8': '#555555',  // Dark Gray
        '9': '#5555FF',  // Blue
        'a': '#55FF55',  // Green
        'b': '#55FFFF',  // Aqua
        'c': '#FF5555',  // Red
        'd': '#FF55FF',  // Light Purple
        'e': '#FFFF55',  // Yellow
        'f': '#FFFFFF'   // White
      };
      
      // Handle formatting codes (bold, italic, etc.)
      const formatMap = {
        'l': 'font-weight: bold;',
        'o': 'font-style: italic;',
        'n': 'text-decoration: underline;',
        'm': 'text-decoration: line-through;',
        'k': 'text-decoration: blink;'  // Obfuscated text
      };
      
      // Split on § character
      const parts = motd.split('§');
      let result = parts[0]; // First part has no formatting
      
      // Process each part after §
      for (let i = 1; i < parts.length; i++) {
        const part = parts[i];
        if (part) {
          const code = part[0].toLowerCase();
          const text = part.substring(1);
          
          let styles = '';
          if (colorMap[code]) {
            styles += `color:${colorMap[code]};`;
          }
          if (formatMap[code]) {
            styles += formatMap[code];
          }
          
          if (styles) {
            result += `<span style="${styles}">${text}</span>`;
          } else {
            result += text; // Unknown code, just add the text
          }
        }
      }
      
      return result;
    }

    // Bind the Refresh All and Check-Page-Whitelist button events.
    $('#refresh-all-btn').on('click', function(){
      refreshAllServers();
    });
    $('#check-page-wl-btn').on('click', function(){
      checkWhitelistCurrentPage();
    });

    // Small helper sleep
    function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

    // Whitelist check with retry/backoff for a single server
    async function doWhitelistCheckWithRetry(serverId) {
      const maxAttempts = 3;
      let attempt = 0;
      while (attempt < maxAttempts) {
        attempt++;
        try {
          const res = await $.ajax({ url: '/api/whitelist_check/' + serverId, method: 'POST' });
          if (res && res.status === 'rate_limited') {
            // Backoff with jitter: 1000ms * 2^(attempt-1) +/- 250ms
            const base = 1000 * Math.pow(2, attempt - 1);
            const jitter = Math.floor(Math.random() * 500) - 250; // [-250, +249]
            await sleep(Math.max(750, base + jitter));
            continue;
          }
          return res;
        } catch (e) {
          // Network error: brief retry once with delay
          if (attempt < maxAttempts) {
            await sleep(800 + Math.floor(Math.random() * 400));
            continue;
          }
          throw e;
        }
      }
      // If exhausted due to rate limit
      return { status: 'rate_limited', message: 'Rate limited after retries' };
    }

    // Sequential whitelist check for current page, refreshing each first
    async function checkWhitelistCurrentPage() {
      let rows = $('tr[data-server-id]');
      if (rows.length === 0) {
        showNotification('No servers on this page.');
        return;
      }
      $('#refresh-progress-container').show();
      $('#refresh-progress-text').text('Checking whitelist for ' + rows.length + ' servers...');
      $('#refresh-progress-bar').css('width', '0%').text('0%');
      let processed = 0;
      function updateProgress() {
        const pct = Math.round((processed / rows.length) * 100);
        $('#refresh-progress-bar').css('width', pct + '%').text(pct + '%');
        if (pct >= 100) {
          setTimeout(function(){ $('#refresh-progress-container').hide(); }, 500);
        }
      }
      for (let i = 0; i < rows.length; i++) {
        const row = $(rows[i]);
        const serverId = row.data('server-id');
        const statusEl = row.find('.wl-status');
        const wlBtn = row.find('.wl-check-btn');
        statusEl.text('');
        wlBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        // 1) Refresh first to get online/offline accurate
        try {
          const response = await $.ajax({ url: '/api/refresh/' + serverId, method: 'POST' });
          if (response.status === 'failed') {
            // mark offline
            row.find('td').eq(9).html('<span class="text-danger">&#x1F534;</span>');
            row.find('td').eq(5).find('.players-number').text('0');
          } else if (response.server) {
            const s = response.server;
            // update row minimal fields and reachable icon
            row.find('td.header-icon img.server-icon').attr('src', '/static/' + s.server_icon);
            row.find('td').eq(3).addClass('motd-text').html(formatMinecraftMOTD(s.motd));
            row.find('td').eq(4).text(s.version);
            row.find('td').eq(5).html(`
              <div class="players-container">
                <div class="players-number">${s.players}</div>
                <button class="btn btn-sm btn-info view-players-btn" data-id="${s.id}" data-ip="${s.ip}" data-port="${s.port}">View Players</button>
              </div>
            `);
            row.find('td').eq(6).text(s.country);
            row.find('td').eq(7).text(s.date_added ? new Date(s.date_added).toLocaleString('sv-SE', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}).replace(' ', ' ') : 'Unknown');
            row.find('td').eq(9).html(s.reachable ? '<span class="text-success">&#x1F7E2;</span>' : '<span class="text-danger">&#x1F534;</span>');
          }
        } catch (e) {
          // network error -> mark offline icon
          row.find('td').eq(9).html('<span class="text-danger">&#x1F534;</span>');
        }
        // 2) If offline, set wl status and skip
        const isOnline = row.find('td').eq(9).find('.text-success').length > 0;
        if (!isOnline) {
          statusEl.text('Offline').css('color', '#6c757d');
          wlBtn.prop('disabled', false).text('Check');
          processed++; updateProgress();
          // Small pacing delay to avoid bursts
          await sleep(150 + Math.floor(Math.random() * 150));
          continue;
        }
        // 3) Perform whitelist check with retries & pacing
        // Base pacing to reduce 429s between joins
        await sleep(250 + Math.floor(Math.random() * 200));
        try {
          const res = await doWhitelistCheckWithRetry(serverId);
          if (res && res.status) {
            let statusText = '';
            let statusColor = '#6c757d';
            if (res.status === 'allowed') { statusText = 'Allowed'; statusColor = '#28a745'; }
            else if (res.status === 'not_whitelisted') { statusText = 'Not whitelisted'; statusColor = '#dc3545'; }
            else if (res.status === 'banned') { statusText = 'Banned'; statusColor = '#dc3545'; }
            else if (res.status === 'server_full') { statusText = 'Server full'; statusColor = '#ffc107'; }
            else if (res.status === 'version_mismatch') { statusText = 'Version mismatch'; statusColor = '#ffc107'; }
            else if (res.status === 'timeout') { statusText = 'Timeout'; statusColor = '#6c757d'; }
            else if (res.status === 'join_forbidden') { statusText = 'Join forbidden'; statusColor = '#dc3545'; }
            else if (res.status === 'rate_limited') { statusText = 'Rate limited'; statusColor = '#ffc107'; }
            else if (res.status === 'error') { statusText = 'Error'; statusColor = '#dc3545'; }
            else if (res.status === 'unknown_disconnect') { statusText = 'Unknown disconnect'; statusColor = '#6c757d'; }
            else { statusText = res.message || res.status; }
            if (res.protocol_version && res.version_name) {
              statusText += ` (${res.version_name})`;
            }
            let tooltipText = res.message || statusText;
            if (res.used_known_version) { tooltipText += '\nUsed known server version for instant detection'; }
            if (res.versions_tried && res.versions_tried.length > 1) { tooltipText += '\nVersions tried: ' + res.versions_tried.join(', '); }
            statusEl.text(statusText).css('color', statusColor).attr('title', tooltipText);
            
            // Save whitelist status to localStorage
            setWhitelistStatus(serverId, {
              statusText: statusText,
              statusColor: statusColor,
              tooltipText: tooltipText,
              status: res.status,
              protocol_version: res.protocol_version,
              version_name: res.version_name,
              used_known_version: res.used_known_version,
              versions_tried: res.versions_tried
            });
          } else {
            statusEl.text('Unknown').css('color', '#6c757d');
          }
        } catch (xhr) {
          let errorMsg = 'Error';
          try { const errorResponse = JSON.parse(xhr.responseText); if (errorResponse.message) { errorMsg = errorResponse.message; } } catch(e){}
          statusEl.text(errorMsg).css('color', '#dc3545');
        } finally {
          wlBtn.prop('disabled', false).text('Check');
        }
        processed++; updateProgress();
      }
      bindRowEvents();
    }

    // Bind events for dynamically added rows
    function bindRowEvents() {
      $('.copy-btn').off('click').on('click', function(){
        var ip = $(this).data('ip');
        var port = $(this).data('port');
        var fullIP = ip + ":" + port;
        navigator.clipboard.writeText(fullIP)
          .then(function(){
            showNotification("Copied " + fullIP + " to clipboard!");
          })
          .catch(function(err){
            console.error(err);
            showNotification("Failed to copy text.");
          });
      });
      $('.view-players-btn').off('click').on('click', function(){
        var serverId = $(this).data('id');
        var ip = $(this).data('ip');
        var port = $(this).data('port');
        $('#modal-server-ip').text(ip);
        $('#modal-server-port').text(port);
        $('#player-list').empty();
        $('#playerListModal').modal('show');
        $.ajax({
          url: "/api/players/" + serverId,
          method: "GET",
          success: function(response) {
            if(response.players && response.players.length > 0) {
              response.players.forEach(function(player){
                $('#player-list').append('<li class="list-group-item">' + $('<div>').text(player).html() + '</li>');
              });
            } else {
              $('#player-list').append('<li class="list-group-item">No players online.</li>');
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.error(textStatus, errorThrown);
            $('#player-list').append('<li class="list-group-item">Failed to fetch players.</li>');
          }
        });
      });
      $('.refresh-btn').off('click').on('click', function(){
        var serverId = $(this).data('id');
        var row = $('tr[data-server-id="' + serverId + '"]');
        $.ajax({
          url: "/api/refresh/" + serverId,
          method: "POST",
          success: function(response) {
            if (response.status === 'failed') {
              row.find('td').eq(9).html('<span class="text-danger">&#x1F534;</span>');
              row.find('td').eq(5).find('.players-number').text('0');
              showNotification("Server " + serverId + " marked offline.");
              return;
            }
            let s = response.server;
            row.find('td.header-icon img.server-icon').attr('src', "/static/" + s.server_icon);
            row.find('td').eq(1).html(`
              <div class="ip-container">
                <div class="ip-text">${s.ip}:${s.port}</div>
                <button class="btn btn-sm btn-secondary copy-btn" data-ip="${s.ip}" data-port="${s.port}">Copy IP</button>
              </div>
            `);
            row.find('td').eq(3).addClass('motd-text').html(formatMinecraftMOTD(s.motd));
            row.find('td').eq(4).text(s.version);
            row.find('td').eq(5).html(`
              <div class="players-container">
                <div class="players-number">${s.players}</div>
                <button class="btn btn-sm btn-info view-players-btn" data-id="${s.id}" data-ip="${s.ip}" data-port="${s.port}">View Players</button>
              </div>
            `);
            row.find('td').eq(6).text(s.country);
            row.find('td').eq(7).text(s.date_added ? new Date(s.date_added).toLocaleString('sv-SE', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}).replace(' ', ' ') : 'Unknown');
            row.find('td').eq(9).html(s.reachable ? '<span class="text-success">&#x1F7E2;</span>' : '<span class="text-danger">&#x1F534;</span>');
            showNotification("Server " + serverId + " refreshed successfully.");
            bindRowEvents();
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.error(textStatus, errorThrown);
            showNotification("Failed to refresh server " + serverId);
          }
        });
      });
      $('.delete-btn').off('click').on('click', function(){
        var serverId = $(this).data('id');
        $('#deleteConfirmModal').data('server-id', serverId).modal('show');
      });
      $('.favorite-btn').off('click').on('click', function(){
        let btn = $(this);
        let serverId = btn.data('id');
        let favs = getFavorites();
        if (favs.indexOf(serverId) === -1) {
          favs.push(serverId);
          updateFavoriteButton(btn, true);
          showNotification("Server " + serverId + " added to favorites.");
        } else {
          favs = favs.filter(function(id) { return id !== serverId; });
          updateFavoriteButton(btn, false);
          showNotification("Server " + serverId + " removed from favorites.");
        }
        setFavorites(favs);
      });
      $('.wl-check-btn').off('click').on('click', function(){
        const btn = $(this);
        const row = btn.closest('tr');
        const statusEl = row.find('.wl-status');
        statusEl.text('');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        const serverId = btn.data('id');
        // Refresh first to ensure reachability is up-to-date
        $.ajax({ url: '/api/refresh/' + serverId, method: 'POST' })
          .always(async function(resp){
            // Update reachable icon
            if (resp && resp.status === 'failed') {
              row.find('td').eq(9).html('<span class="text-danger">&#x1F534;</span>');
            } else if (resp && resp.server) {
              row.find('td').eq(9).html(resp.server.reachable ? '<span class="text-success">&#x1F7E2;</span>' : '<span class="text-danger">&#x1F534;</span>');
            }
            const isOnline = row.find('td').eq(9).find('.text-success').length > 0;
            if (!isOnline) {
              statusEl.text('Offline').css('color', '#6c757d');
              btn.prop('disabled', false).text('Check');
              return;
            }
            // Brief pacing before join
            await sleep(250 + Math.floor(Math.random() * 200));
            // Proceed with whitelist check with retry/backoff
            try {
              const res = await doWhitelistCheckWithRetry(serverId);
              if (res && res.status) {
                var statusText = '';
                var statusColor = '#6c757d';
                
                if (res.status === 'allowed') {
                  statusText = 'Allowed';
                  statusColor = '#28a745';
                } else if (res.status === 'not_whitelisted') {
                  statusText = 'Not whitelisted';
                  statusColor = '#dc3545';
                } else if (res.status === 'banned') {
                  statusText = 'Banned';
                  statusColor = '#dc3545';
                } else if (res.status === 'server_full') {
                  statusText = 'Server full';
                  statusColor = '#ffc107';
                } else if (res.status === 'version_mismatch') {
                  statusText = 'Version mismatch';
                  statusColor = '#ffc107';
                } else if (res.status === 'timeout') {
                  statusText = 'Timeout';
                  statusColor = '#6c757d';
                } else if (res.status === 'join_forbidden') {
                  statusText = 'Join forbidden';
                  statusColor = '#dc3545';
                } else if (res.status === 'rate_limited') {
                  statusText = 'Rate limited';
                  statusColor = '#ffc107';
                } else if (res.status === 'error') {
                  statusText = 'Error';
                  statusColor = '#dc3545';
                } else if (res.status === 'unknown_disconnect') {
                  statusText = 'Unknown disconnect';
                  statusColor = '#6c757d';
                } else {
                  statusText = res.message || res.status;
                }
                
                // Add protocol version info if available
                if (res.protocol_version && res.version_name) {
                  statusText += ` (${res.version_name})`;
                }
                
                // Add tooltip with more details
                var tooltipText = res.message || statusText;
                if (res.used_known_version) {
                  tooltipText += '\nUsed known server version for instant detection';
                }
                if (res.versions_tried && res.versions_tried.length > 1) {
                  tooltipText += '\nVersions tried: ' + res.versions_tried.join(', ');
                }
                
                statusEl.text(statusText).css('color', statusColor).attr('title', tooltipText);
                
                // Save whitelist status to localStorage
                setWhitelistStatus(serverId, {
                  statusText: statusText,
                  statusColor: statusColor,
                  tooltipText: tooltipText,
                  status: res.status,
                  protocol_version: res.protocol_version,
                  version_name: res.version_name,
                  used_known_version: res.used_known_version,
                  versions_tried: res.versions_tried
                });
              } else {
                statusEl.text('Unknown').css('color', '#6c757d');
              }
            } catch (xhr) {
              let errorMsg = 'Error';
              try {
                const errorResponse = JSON.parse(xhr.responseText);
                if (errorResponse.message) {
                  errorMsg = errorResponse.message;
                }
              } catch (e) {
                // Keep default error message
              }
              statusEl.text(errorMsg).css('color', '#dc3545');
            } finally {
              btn.prop('disabled', false).text('Check');
            }
          });
      });
      $('#deleteConfirmModal').off('click', '#confirm-delete-btn').on('click', '#confirm-delete-btn', function(){
        var serverId = $('#deleteConfirmModal').data('server-id');
        $.ajax({
          url: "/api/delete/" + serverId,
          method: "DELETE",
          success: function(response) {
            showNotification("Server " + serverId + " deleted successfully.");
            $('tr[data-server-id="'+serverId+'"]').remove();
            $('#deleteConfirmModal').modal('hide');
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.error(textStatus, errorThrown);
            showNotification("Failed to delete server " + serverId);
            $('#deleteConfirmModal').modal('hide');
          }
        });
      });
    }
    // When the cogwheel is pressed, open the refresh configuration modal
    $('#refresh-config-btn').on('click', function(){
      // Show modal immediately - no need to load old auth status
        $('#generalSettingsModal').modal('show');
      });
    // Save refresh configuration and authentication
    $('#save-settings-btn').on('click', function(){
      let val = parseInt($('#refresh-count-input').val(), 10);
      if(val && val > 0) {
        refreshCount = val;
      }
      
      // Token-based authentication only
      let authData = {};
      const accessToken = $('#access-token-input').val().trim();
      if (accessToken) {
        authData.access_token = accessToken;
      }
      
      if (Object.keys(authData).length === 0) {
        showNotification('Please provide a Minecraft access token.');
        return;
      }
      
      $.ajax({
        url: '/api/auth/update',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(authData)
      }).done(function(response){
        if (response.status === 'success') {
          showNotification('Authentication saved successfully.');
          $('#generalSettingsModal').modal('hide');
          // Clear field
          $('#access-token-input').val('');
        } else {
          showNotification('Error: ' + (response.message || 'Unknown error'));
        }
      }).fail(function(xhr){
        let errorMsg = 'Failed to save authentication.';
        try {
          const errorResponse = JSON.parse(xhr.responseText);
          if (errorResponse.message) {
            errorMsg = errorResponse.message;
          }
        } catch (e) {
          // Keep default error message
        }
        showNotification('Error: ' + errorMsg);
      });
    });
    // Function to show a notification
    function showNotification(message) {
      var notification = $('<div class="notification"></div>').text(message);
      $("#notification-container").append(notification);
      setTimeout(function(){
        notification.fadeOut(500, function(){ $(this).remove(); });
      }, 3000);
    }
    // Jump-to-page functionality
    $('#jump-page-btn').on('click', function(){
      let targetPage = $('#jump-page').val();
      if(targetPage && targetPage > 0) {
        let currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('page', targetPage);
        window.location.href = currentUrl.toString();
      }
    });
    // Handle Copy IP button click using clipboard API
    $('.copy-btn').on('click', function(){
      var ip = $(this).data('ip');
      var port = $(this).data('port');
      var fullIP = ip + ":" + port;
      navigator.clipboard.writeText(fullIP)
        .then(function(){
          showNotification("Copied " + fullIP + " to clipboard!");
        })
        .catch(function(err){
          console.error(err);
          showNotification("Failed to copy text.");
        });
    });
    // Handle Search button click: if in favorites view, filter client-side; else navigate
    $('#search-btn').on('click', function(){
      var searchTerm = $('#search').val().toLowerCase();
      if (showFavoritesOnly) {
        // Client-side filter rows in favorites view
        $('#server-list tr').each(function() {
          var row = $(this);
          var text = row.text().toLowerCase();
          row.toggle(text.indexOf(searchTerm) !== -1);
        });
        return;
      }
      var currentPerPage = $('#per-page-select').val();
      window.location.href = window.location.pathname + "?search=" + encodeURIComponent(searchTerm) + "&page=1&per_page=" + currentPerPage;
    });
    
    // Handle Enter key press in search input
    $('#search').on('keypress', function(e){
      if (e.which === 13) { // Enter key
        $('#search-btn').click();
      }
    });
    // Handle per-page dropdown change
    $('#per-page-select').on('change', function(){
      let perPage = $(this).val();
      let currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('per_page', perPage);
      currentUrl.searchParams.set('page', 1);
      window.location.href = currentUrl.toString();
    });
    // Sorting: if in favorites view, sort client-side; else navigate with params
    $('.sort-header').on('click', function(){
      var sortBy = $(this).data('sort-by');
      if (showFavoritesOnly) {
        var rows = $('#server-list tr').get();
        var ascending = !$(this).data('sorted-asc');
        $(this).data('sorted-asc', ascending);
        rows.sort(function(a, b){
          function getCell(row, key){
            var $row = $(row);
            switch(key){
              case 'ip': return $row.find('.ip-text').text();
              case 'motd': return $row.find('td').eq(3).text();
              case 'version': return $row.find('td').eq(4).text();
              case 'players': return parseInt($row.find('.players-number').text() || '0', 10);
              case 'country': return $row.find('td').eq(6).text();
              case 'date_added': return $row.find('td').eq(7).text();
              case 'reachable': return $row.find('td').eq(9).find('.text-success').length ? 1 : 0;
              default: return $row.text();
            }
          }
          var av = getCell(a, sortBy);
          var bv = getCell(b, sortBy);
          if ($.isNumeric(av) && $.isNumeric(bv)){
            return ascending ? (av - bv) : (bv - av);
          }
          av = (av||'').toString().toLowerCase();
          bv = (bv||'').toString().toLowerCase();
          if (av < bv) return ascending ? -1 : 1;
          if (av > bv) return ascending ? 1 : -1;
          return 0;
        });
        $.each(rows, function(_, row){ $('#server-list').append(row); });
        return;
      }
      var currentUrl = new URL(window.location.href);
      var currentSortBy = currentUrl.searchParams.get('sort_by') || 'id';
      var currentSortOrder = currentUrl.searchParams.get('sort_order') || 'asc';
      var newSortOrder = (sortBy === currentSortBy && currentSortOrder === 'asc') ? 'desc' : 'asc';
      currentUrl.searchParams.set('sort_by', sortBy);
      currentUrl.searchParams.set('sort_order', newSortOrder);
      currentUrl.searchParams.set('page', 1);
      window.location.href = currentUrl.toString();
    });

    // ==============================
    // STICKY HEADER FUNCTIONALITY
    // ==============================
    
    $(document).ready(function() {
      const stickyHeader = $('#sticky-header');
      const originalControls = $('.sticky-top-bar');
      let isSticky = false;
      
      // Sync sticky header controls with original values
      function syncStickyControls() {
        // Sync search input
        $('#sticky-search').val($('#search').val());
        
        // Sync per page select
        $('#sticky-per-page-select').val($('#per-page-select').val());
        
        // Sync favorites button state
        const originalFavBtn = $('#toggle-favorites-btn');
        const stickyFavBtn = $('#sticky-toggle-favorites-btn');
        
        if (originalFavBtn.hasClass('btn-warning')) {
          stickyFavBtn.removeClass('btn-secondary').addClass('btn-warning');
          stickyFavBtn.find('i').removeClass('far').addClass('fas');
        } else {
          stickyFavBtn.removeClass('btn-warning').addClass('btn-secondary');
          stickyFavBtn.find('i').removeClass('fas').addClass('far');
        }
        
        // Update sticky pagination
        updateStickyPagination();
      }
      
      // Update sticky pagination from original
      function updateStickyPagination() {
        const originalPagination = $('#pagination-nav-top ul.pagination').clone();
        if (originalPagination.length) {
          $('#sticky-pagination').html(originalPagination).removeClass('d-none d-lg-block').addClass('d-inline-block');
        }
      }
      
      // Show sticky progress bar
      function showStickyProgress() {
        // Only show if not hidden by CSS media queries
        if ($(window).width() > 992) {
          $('#sticky-progress-container').fadeIn(300);
          startProgressSync();
        }
      }
      
      // Hide sticky progress bar
      function hideStickyProgress() {
        $('#sticky-progress-container').fadeOut(300);
      }
      
      // Sync sticky progress with main progress
      function startProgressSync() {
        const syncInterval = setInterval(function() {
          const mainProgressBar = $('#refresh-progress-bar');
          const mainProgressText = $('#refresh-progress-text');
          
                     if (mainProgressBar.length && mainProgressText.length) {
             const progress = mainProgressBar.attr('style');
             const text = mainProgressText.text();
             
             // Extract percentage from progress bar text or calculate from width
             let progressPercent = mainProgressBar.text().trim();
             if (!progressPercent || !progressPercent.includes('%')) {
               // Extract width% from inline style if present
               const match = /width:\s*([^;]+)/.exec(progress || '');
               if (match && match[1]) {
                 progressPercent = match[1].trim();
               } else {
                 progressPercent = '0%';
               }
             }
             
             // For horizontal layout, just show percentage
             let compactText = progressPercent;
             if (text.includes('Complete') || text.includes('Finishing')) {
               compactText = '✓';
             }
             
                         $('#sticky-progress-bar').css('width', progressPercent);
            $('#sticky-progress-text').text(compactText);
            
            // Check if progress is complete or container is hidden
            const mainContainer = $('#refresh-progress-container');
            if (mainContainer.is(':hidden') || progress === '100%' || text.includes('Complete')) {
              clearInterval(syncInterval);
              setTimeout(hideStickyProgress, 2000); // Hide after 2 seconds
            }
          } else {
            clearInterval(syncInterval);
            hideStickyProgress();
          }
        }, 100); // Check every 100ms for smooth updates
      }
      
      // Scroll detection
      $(window).on('scroll', function() {
        const scrollTop = $(window).scrollTop();
        const controlsOffset = originalControls.offset().top + originalControls.outerHeight();
        
        if (scrollTop > controlsOffset && !isSticky) {
          isSticky = true;
          stickyHeader.addClass('visible');
          $('body').addClass('sticky-active');
          syncStickyControls();
        } else if (scrollTop <= controlsOffset && isSticky) {
          isSticky = false;
          stickyHeader.removeClass('visible');
          $('body').removeClass('sticky-active');
        }
      });
      
      // Sticky control event handlers
      
      // Sticky Refresh All
      $('#sticky-refresh-all-btn').on('click', function() {
        $('#refresh-all-btn').click();
        // Show sticky progress bar when refresh starts
        if (isSticky) {
          showStickyProgress();
        }
      });
      // Sticky Check Page Whitelist
      $('#sticky-check-page-wl-btn').on('click', function(){
        $('#check-page-wl-btn').click();
        if (isSticky) { showStickyProgress(); }
      });
      
      // Sticky Config
      $('#sticky-refresh-config-btn').on('click', function() {
        $('#refresh-config-btn').click();
      });
      
      // Sticky Favorites Toggle
      $('#sticky-toggle-favorites-btn').on('click', function() {
        $('#toggle-favorites-btn').click();
      });
      
      // Sticky Search
      $('#sticky-search-btn').on('click', function() {
        const searchTerm = $('#sticky-search').val();
        const currentPerPage = $('#sticky-per-page-select').val();
        window.location.href = window.location.pathname + "?search=" + encodeURIComponent(searchTerm) + "&page=1&per_page=" + currentPerPage;
      });
      
      // Sticky Search Enter Key
      $('#sticky-search').on('keypress', function(e) {
        if (e.which === 13) {
          $('#sticky-search-btn').click();
        }
      });
      
      // Sticky Per Page Change
      $('#sticky-per-page-select').on('change', function() {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('per_page', $(this).val());
        currentUrl.searchParams.set('page', 1);
        window.location.href = currentUrl.toString();
      });
      
      // Update sticky controls when original controls change
      $('#search').on('input', function() {
        if (isSticky) $('#sticky-search').val($(this).val());
      });
      
      $('#per-page-select').on('change', function() {
        if (isSticky) $('#sticky-per-page-select').val($(this).val());
      });
      
      // Re-sync when favorites state changes
      $('#toggle-favorites-btn').on('click', function() {
        setTimeout(function() {
          syncStickyControls();
          // Show sticky pagination when not in favorites view
          if (!showFavoritesOnly) {
            $("#sticky-pagination").show();
          }
                 }, 100);
       });
       
       // Watch for main progress bar changes to auto-show sticky progress
       const observer = new MutationObserver(function(mutations) {
         mutations.forEach(function(mutation) {
           if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
             const mainContainer = $('#refresh-progress-container');
             if (isSticky && mainContainer.is(':visible') && !$('#sticky-progress-container').is(':visible')) {
               showStickyProgress();
             }
           }
         });
       });
       
       // Start observing the main progress container
       const mainProgressContainer = document.getElementById('refresh-progress-container');
       if (mainProgressContainer) {
         observer.observe(mainProgressContainer, { 
           attributes: true, 
           attributeFilter: ['style'] 
         });
       }
     });
   </script>
</body>
</html>

